<!doctype html>
<html>
<head>
  <title>Fractals</title>
</head>
<body>
  <script src="https://threejs.org/build/three.min.js"></script>
  <script src="https://threejs.org/examples/js/controls/FirstPersonControls.js"></script>
  <script src="https://threejs.org/examples/js/loaders/OBJLoader.js"></script>
	<script src="https://threejs.org/examples/js/loaders/MTLLoader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>

  <script src="./shaders/vertexShader.js" type="text/javascript"></script>
  <script src="./shaders/fragmentShader.js" type="text/javascript"></script>
  <script src="./scripts/buildTree.js" type="text/javascript"></script>
  <script src="./scripts/terrain.js" type="text/javascript"></script>

  <script>
  "use strict";
	let scene, camera, renderer, cameraControls;
  let group =new THREE.Group();
	let WIDTH  = window.innerWidth;
	let HEIGHT = window.innerHeight;

  var clock = new THREE.Clock();

	function init() {
		scene = new THREE.Scene();
		initRenderer();
		initScene();
    eventHandlers();
	}

	function initRenderer() {
		renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize(WIDTH, HEIGHT);
    renderer.setClearColor(0xe3e1e1, 1);
		document.body.appendChild(renderer.domElement);
	}

	function initScene() {

		initCamera();
    let textureLoader = new THREE.TextureLoader();
    let rock_texture = textureLoader.load('./textures/rock2.jpg', function (texture) { render(); });
    let grass_texture = textureLoader.load('./textures/grass.jpg', function (texture) { render(); });
    let snow_texture = textureLoader.load('./textures/snow.jpg', function (texture) { render(); });

    let trump_texture = textureLoader.load('./textures/trump-angry.jpg', function (texture) { render(); });

    let geometry = new THREE.PlaneGeometry(width, length, segmentLength, segmentLength);
    let heightMap = TerrainGeneration(segmentLength, 50);
    let index = 0;

    // set vertex heights based on height map
    for (var i = 0; i <= segmentLength; i++)
    {
      for (var j = 0; j <= segmentLength; j++)
      {
        geometry.vertices[index].z = heightMap[i][j];
        index++;
      }
    }

    let up = new THREE.Vector3(0, 1, 0);
    let sky = new THREE.Vector3(0.887, 0.879, 0.879);
    let uniforms = {
      upDirection: {
        value: up
      },
      snow: {
        type: "t",
        value: snow_texture
      },
      rock: {
        type: "t",
        value: rock_texture
      },
      grass: {
        type: "t",
        value: grass_texture
      },
      skyLight: {
        value: sky
      }
    };

    let material2 = new THREE.RawShaderMaterial({
      fragmentShader: getFragmentShader(),
      vertexShader: getVertexShader(),
      uniforms: uniforms
    });

    let material = new THREE.MeshBasicMaterial( { map: rock_texture });
    let plane = new THREE.Mesh(geometry, material2);

    plane.rotation.x = THREE.Math.degToRad(-90);
    plane.position.set(0, -10, 0);
    scene.add(plane);

    let directionalLight = new THREE.DirectionalLight(
			0xffffff,.9);
		directionalLight.position.set(0, 50, 0).normalize();
    directionalLight.target = plane;
    scene.add(directionalLight)
    //scene.fog = new THREE.FogExp2(0xe3e1e1, .06);

    initTree(new THREE.Vector3(0, 0, 0));
    generateLSystem("F", 2);
    let branches = getBranches();

    var addBranch = function (branch, index, arr) {
      if (index != 0)
        group.add(branch.clone());
      console.log("added branch");
      scene.add(branch);
    }

    branches.forEach(addBranch);
    // group.rotation.set(0, Math.PI/2.0,, 0, "XYZ");
    scene.add(group);
    group.rotation.set(0, Math.PI/2.0, 0, "XYZ");
  }

	function initCamera() {
		camera = new THREE.PerspectiveCamera(50, WIDTH / HEIGHT, 1, 20000);
		camera.position.set(0, 3.5, 5);
		camera.lookAt(scene.position);
		cameraControls = new THREE.FirstPersonControls (
			camera, renderer.domElement
		);

		cameraControls.movementSpeed = 12;
    cameraControls.lookSpeed = .08;
	}

  function eventHandlers() {
    handleWindowResize();
  }

	function handleWindowResize(){
		window.addEventListener (
			"resize",
			function () {
				WIDTH = window.innerWidth ;
				HEIGHT = window.innerHeight;
				renderer.setSize(WIDTH,HEIGHT);
				camera.aspect = WIDTH/HEIGHT;
				camera.updateProjectionMatrix();
        cameraControls.handleResize();
        render();
			}
		);
	}

  function animate() {
    requestAnimationFrame( animate );
    render();
  }

  function render() {

    renderer.render(scene, camera);
     cameraControls.update(clock.getDelta());
  }

	init();
	animate();
  </script>

</body>
</html>
